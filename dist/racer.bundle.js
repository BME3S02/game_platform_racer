!function(e){function t(a){if(n[a])return n[a].exports;var s=n[a]={i:a,l:!1,exports:{}};return e[a].call(s.exports,s,s.exports,t),s.l=!0,s.exports}var n={};t.m=e,t.c=n,t.d=function(e,n,a){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:a})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=0)}([function(e,t){function n(e,t){return Math.random()*(t-e)+e}function a(e,t,n,a){var s=e-n,i=t-a;return Math.sqrt(Math.pow(s,2)+Math.pow(i,2))}function s(e,t,s,i){for(this.x=e,this.y=t,this.sx=e,this.sy=t,this.tx=s,this.ty=i,this.distanceToTarget=a(e,t,s,i),this.distanceTraveled=0,this.coordinates=[],this.coordinateCount=3;this.coordinateCount--;)this.coordinates.push([this.x,this.y]);this.angle=Math.atan2(i-t,s-e),this.speed=3,this.acceleration=1,this.brightness=n(50,70),this.targetRadius=1}function i(e,t){for(this.x=e,this.y=t,this.coordinates=[],this.coordinateCount=5;this.coordinateCount--;)this.coordinates.push([this.x,this.y]);this.angle=n(0,2*Math.PI),this.speed=n(1,10),this.friction=.95,this.gravity=1,this.hue=n(ae-50,ae+50),this.brightness=n(50,80),this.alpha=1,this.decay=n(.015,.03)}function o(e,t){for(var n=500;n--;)ne.push(new i(e,t))}function r(){requestAnimFrame(r),ae=n(0,360),J.globalCompositeOperation="destination-out",J.fillStyle="rgba(0, 0, 0, 0.5)",J.fillRect(0,0,Q,ee),J.globalCompositeOperation="lighter";for(var e=te.length;e--;)te[e].draw(),te[e].update(e);for(var e=ne.length;e--;)ne[e].draw(),ne[e].update(e);re>=oe?le||(te.push(new s(Q/2,ee,n(0,Q),n(0,ee/2))),re=0):re++,ie>=se?le&&(te.push(new s(Q/2,ee,Z,K)),ie=0):ie++}function l(){j.width=Q=canvas.width,j.height=ee=canvas.height,r()}function c(){var e=$("#canvas")[0];$("#canvas")[1];"function"==typeof e.webkitRequestFullScreen&&$("#canvas")[0].webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT),"function"==typeof e.mozRequestFullScreen&&$("#canvas")[0].mozRequestFullScreen()}function d(){_.get("lanes").selectedIndex=lanes-1,_.get("currentRoadWidth").innerHTML=_.get("roadWidth").value=roadWidth,_.get("currenttotalCars").innerHTML=_.get("totalCars").value=totalCars,_.get("currentmaxSpeed").innerHTML=_.get("maxSpeed").value=maxSpeed,_.get("currentmaxTime").innerHTML=_.get("maxTime").value=maxTime}function h(e){e=e||{},canvas.width=width=G.toInt(e.width,width),canvas.height=height=G.toInt(e.height,height),lanes=G.toInt(e.lanes,lanes),totalCars=G.toInt(e.totalCars,totalCars),roadWidth=G.toInt(e.roadWidth,roadWidth),maxSpeed=G.toInt(e.maxSpeed,maxSpeed),segmentLength=G.toInt(e.segmentLength,segmentLength),rumbleLength=G.toInt(e.rumbleLength,rumbleLength),cameraDepth=1/Math.tan(fieldOfView/2*Math.PI/180),playerZ=cameraHeight*cameraDepth,resolution=height/480,maxTime=G.toInt(e.maxTime,maxTime),d(),(0==segments.length||e.segmentLength||e.rumbleLength||e.totalCars)&&b()}function u(){document.dispatchEvent(new Event("finished")),keyLeft=keyRight=keySlower=keyFaster=!1,m("遊戲結束","inf"),l()}function m(e,t){var n=$("#toast"),a=function(){n.removeClass("show")};n.html(e),n.addClass("show"),clearTimeout(a),"inf"!=t&&setTimeout(a,t||2e3)}function p(){fps=60,step=1/fps,width=1024,height=768,centrifugal=.3,offRoadDecel=.99,skySpeed=.001,hillSpeed=.002,treeSpeed=.003,skyOffset=0,hillOffset=0,treeOffset=0,segments=[],cars=[],stats=P.stats("fps"),canvas=_.get("canvas"),ctx=canvas.getContext("2d"),background=null,sprites=null,resolution=null,roadWidth=$("#roadWidth").val(),segmentLength=300,rumbleLength=3,trackLength=100,lanes=5,fieldOfView=100,cameraHeight=1e3,cameraDepth=null,drawDistance=300,playerX=0,playerZ=null,fogDensity=5,position=0,speed=0,maxSpeed=$("#maxSpeed").val(),accel=maxSpeed/5,breaking=-maxSpeed,decel=-maxSpeed/5,offRoadDecel=-maxSpeed/2,offRoadLimit=maxSpeed/4,totalCars=$("#totalCars").val(),currentLapTime=0,lastLapTime=null,keyLeft=!1,keyRight=!1,keyFaster=!0,keySlower=!1,maxTime=$("#maxTime").val(),hud={speed:{value:null,dom:_.get("speed_value")},current_lap_time:{value:null,dom:_.get("current_lap_time_value")},last_lap_time:{value:null,dom:_.get("last_lap_time_value")},fast_lap_time:{value:null,dom:_.get("fast_lap_time_value")}}}function g(e){var t,n,a,s,i,o=w(position+playerZ),r=V.PLAYER_STRAIGHT.w*V.SCALE,l=speed/maxSpeed,c=2*e*l,d=position;if(f(e,o,r),position=G.increase(position,e*speed,trackLength),keyLeft?playerX-=c:keyRight&&(playerX+=c),playerX-=c*l*o.curve*centrifugal,keyFaster?speed=G.accelerate(speed,accel,e):keySlower?speed=G.accelerate(speed,breaking,e):speed=G.accelerate(speed,decel,e),playerX<-1||playerX>1)for(speed>offRoadLimit&&(speed=G.accelerate(speed,offRoadDecel,e)),t=0;t<o.sprites.length;t++)if(s=o.sprites[t],i=s.source.w*V.SCALE,G.overlap(playerX,r,s.offset+i/2*(s.offset>0?1:-1),i)){speed=maxSpeed/5,position=G.increase(o.p1.world.z,-playerZ,trackLength);break}for(t=0;t<o.cars.length;t++)if(n=o.cars[t],a=n.sprite.w*V.SCALE,speed>n.speed&&G.overlap(playerX,r,n.offset,a,.8)){var h=new Audio("music/crash.mp3");h.play(),speed=n.speed*(n.speed/speed),position=G.increase(n.z,-playerZ,trackLength);break}playerX=G.limit(playerX,-3,3),speed=G.limit(speed,0,maxSpeed),skyOffset=G.increase(skyOffset,skySpeed*o.curve*(position-d)/segmentLength,1),hillOffset=G.increase(hillOffset,hillSpeed*o.curve*(position-d)/segmentLength,1),treeOffset=G.increase(treeOffset,treeSpeed*o.curve*(position-d)/segmentLength,1),position>playerZ&&(currentLapTime&&d<playerZ?(m("你贏了!"),lastLapTime=currentLapTime,lastLapTime<=G.toFloat(_.storage.fast_lap_time)?(_.storage.fast_lap_time=lastLapTime,y("fast_lap_time",E(lastLapTime)),_.addClassName("fast_lap_time","fastest"),_.addClassName("last_lap_time","fastest")):(_.removeClassName("fast_lap_time","fastest"),_.removeClassName("last_lap_time","fastest")),y("last_lap_time",E(lastLapTime)),_.show("last_lap_time")):currentLapTime+=e),y("speed",5*Math.round(speed/500)),y("current_lap_time",E(currentLapTime))}function f(e,t,n){var a,s,i,o;for(a=0;a<cars.length;a++)s=cars[a],i=w(s.z),s.offset=s.offset+L(s,i,t,n),s.z=G.increase(s.z,e*s.speed,trackLength),s.percent=G.percentRemaining(s.z,segmentLength),o=w(s.z),i!=o&&(index=i.cars.indexOf(s),i.cars.splice(index,1),o.cars.push(s))}function L(e,t,n,a){var s,i,o,r,l,c=e.sprite.w*V.SCALE;if(t.index-n.index>drawDistance)return 0;for(s=1;s<20;s++){if((o=segments[(t.index+s)%segments.length])===n&&e.speed>speed&&G.overlap(playerX,a,e.offset,c,1.2))return 1*(playerX>.5?-1:playerX<-.5?1:e.offset>playerX?1:-1)/s*(e.speed-speed)/maxSpeed;for(i=0;i<o.cars.length;i++)if(r=o.cars[i],l=r.sprite.w*V.SCALE,e.speed>r.speed&&G.overlap(e.offset,c,r.offset,l,1.2))return 1*(r.offset>.5?-1:r.offset<-.5?1:e.offset>r.offset?1:-1)/s*(e.speed-r.speed)/maxSpeed}return e.offset<-.9?.1:e.offset>.9?-.1:0}function y(e,t){hud[e].value!==t&&(hud[e].value=t,_.set(hud[e].dom,t))}function E(e){var t=Math.floor(e/60),n=Math.floor(e-60*t),a=Math.floor(10*(e-Math.floor(e)));return t>0?t+"."+(n<10?"0":"")+n+"."+a:n+"."+a}function x(){var e=w(position),t=G.percentRemaining(position,segmentLength),n=w(position+playerZ),a=G.percentRemaining(position+playerZ,segmentLength),s=G.interpolate(n.p1.world.y,n.p2.world.y,a),i=height,o=0,r=-e.curve*t;ctx.clearRect(0,0,width,height),F.background(ctx,background,width,height,q.SKY,skyOffset,resolution*skySpeed*s),F.background(ctx,background,width,height,q.HILLS,hillOffset,resolution*hillSpeed*s),F.background(ctx,background,width,height,q.TREES,treeOffset,resolution*treeSpeed*s);var l,c,d,h,u,m,p,g;for(l=0;l<drawDistance;l++)d=segments[(e.index+l)%segments.length],d.looped=d.index<e.index,d.fog=G.exponentialFog(l/drawDistance,fogDensity),d.clip=i,G.project(d.p1,playerX*roadWidth-o,s+cameraHeight,position-(d.looped?trackLength:0),cameraDepth,width,height,roadWidth),G.project(d.p2,playerX*roadWidth-o-r,s+cameraHeight,position-(d.looped?trackLength:0),cameraDepth,width,height,roadWidth),o+=r,r+=d.curve,d.p1.camera.z<=cameraDepth||d.p2.screen.y>=d.p1.screen.y||d.p2.screen.y>=i||(F.segment(ctx,width,lanes,d.p1.screen.x,d.p1.screen.y,d.p1.screen.w,d.p2.screen.x,d.p2.screen.y,d.p2.screen.w,d.fog,d.color),i=d.p1.screen.y);for(l=drawDistance-1;l>0;l--){for(d=segments[(e.index+l)%segments.length],c=0;c<d.cars.length;c++)h=d.cars[c],u=h.sprite,m=G.interpolate(d.p1.screen.scale,d.p2.screen.scale,h.percent),p=G.interpolate(d.p1.screen.x,d.p2.screen.x,h.percent)+m*h.offset*roadWidth*width/2,g=G.interpolate(d.p1.screen.y,d.p2.screen.y,h.percent),F.sprite(ctx,width,height,resolution,roadWidth,sprites,h.sprite,m,p,g,-.5,-1,d.clip);for(c=0;c<d.sprites.length;c++)u=d.sprites[c],m=d.p1.screen.scale,p=d.p1.screen.x+m*u.offset*roadWidth*width/2,g=d.p1.screen.y,F.sprite(ctx,width,height,resolution,roadWidth,sprites,u.source,m,p,g,u.offset<0?-1:0,-1,d.clip);d==n&&F.player(ctx,width,height,resolution,roadWidth,sprites,speed/maxSpeed,cameraDepth/playerZ,width/2,height/2-cameraDepth/playerZ*G.interpolate(n.p1.camera.y,n.p2.camera.y,a)*height/2,speed*(keyLeft?-1:keyRight?1:0),n.p2.world.y-n.p1.world.y)}}function w(e){return segments[Math.floor(e/segmentLength)%segments.length]}function v(){return 0==segments.length?0:segments[segments.length-1].p2.world.y}function I(e,t){var n=segments.length;segments.push({index:n,p1:{world:{y:v(),z:n*segmentLength},camera:{},screen:{}},p2:{world:{y:t,z:(n+1)*segmentLength},camera:{},screen:{}},curve:e,sprites:[],cars:[],color:Math.floor(n/rumbleLength)%2?z.DARK:z.LIGHT})}function T(e,t,n){segments[e].sprites.push({source:t,offset:n})}function M(e,t,n,a,s){var i,o=v(),r=o+G.toInt(s,0)*segmentLength,l=e+t+n;for(i=0;i<e;i++)I(G.easeIn(0,a,i/e),G.easeInOut(o,r,i/l));for(i=0;i<t;i++)I(a,G.easeInOut(o,r,(e+i)/l));for(i=0;i<n;i++)I(G.easeInOut(a,0,i/n),G.easeInOut(o,r,(e+t+i)/l))}function R(e){e=e||ce.LENGTH.MEDIUM,M(e,e,e,0,0)}function S(e,t){e=e||ce.LENGTH.MEDIUM,t=t||ce.HILL.MEDIUM,M(e,e,e,0,t)}function A(e,t,n){e=e||ce.LENGTH.MEDIUM,t=t||ce.CURVE.MEDIUM,n=n||ce.HILL.NONE,M(e,e,e,t,n)}function C(e,t){e=e||ce.LENGTH.SHORT,t=t||ce.HILL.LOW,M(e,e,e,0,t/2),M(e,e,e,0,-t),M(e,e,e,ce.CURVE.EASY,t),M(e,e,e,0,0),M(e,e,e,-ce.CURVE.EASY,t/2),M(e,e,e,0,0)}function k(){M(ce.LENGTH.MEDIUM,ce.LENGTH.MEDIUM,ce.LENGTH.MEDIUM,-ce.CURVE.EASY,ce.HILL.NONE),M(ce.LENGTH.MEDIUM,ce.LENGTH.MEDIUM,ce.LENGTH.MEDIUM,ce.CURVE.MEDIUM,ce.HILL.MEDIUM),M(ce.LENGTH.MEDIUM,ce.LENGTH.MEDIUM,ce.LENGTH.MEDIUM,ce.CURVE.EASY,-ce.HILL.LOW),M(ce.LENGTH.MEDIUM,ce.LENGTH.MEDIUM,ce.LENGTH.MEDIUM,-ce.CURVE.EASY,ce.HILL.MEDIUM),M(ce.LENGTH.MEDIUM,ce.LENGTH.MEDIUM,ce.LENGTH.MEDIUM,-ce.CURVE.MEDIUM,-ce.HILL.MEDIUM)}function D(){M(10,10,10,0,5),M(10,10,10,0,-2),M(10,10,10,0,-5),M(10,10,10,0,8),M(10,10,10,0,5),M(10,10,10,0,-7),M(10,10,10,0,5),M(10,10,10,0,-2)}function H(e){e=e||200,M(e,e,e,-ce.CURVE.EASY,-v()/segmentLength)}function b(){segments=[],R(ce.LENGTH.SHORT),C(),k(),A(ce.LENGTH.MEDIUM,ce.CURVE.MEDIUM,ce.HILL.LOW),D(),C(),A(2*ce.LENGTH.LONG,ce.CURVE.MEDIUM,ce.HILL.MEDIUM),R(),S(ce.LENGTH.MEDIUM,ce.HILL.HIGH),k(),A(ce.LENGTH.LONG,-ce.CURVE.MEDIUM,ce.HILL.NONE),S(ce.LENGTH.LONG,ce.HILL.HIGH),A(ce.LENGTH.LONG,ce.CURVE.MEDIUM,-ce.HILL.LOW),D(),S(ce.LENGTH.LONG,-ce.HILL.MEDIUM),R(),k(),H(),O(),U(),segments[w(playerZ).index+2].color=z.START,segments[w(playerZ).index+3].color=z.START;for(var e=0;e<rumbleLength;e++)segments[segments.length-1-e].color=z.FINISH;trackLength=segments.length*segmentLength}function O(){console.log("called resetSprites");var e;for(e=10;e<200;e+=4+Math.floor(e/100))T(e,V.PALM_TREE,.5+.5*Math.random()),T(e,V.PALM_TREE,1+2*Math.random());for(e=250;e<1e3;e+=5)T(e,V.COLUMN,1.1),T(e+G.randomInt(0,5),V.TREE1,-1-2*Math.random()),T(e+G.randomInt(0,5),V.TREE2,-1-2*Math.random());for(e=200;e<segments.length;e+=3)T(e,G.randomChoice(V.PLANTS),G.randomChoice([1,-1])*(2+5*Math.random()));var t;for(e=1e3;e<segments.length-50;e+=100)t=G.randomChoice([1,-1]),T(e+G.randomInt(0,50),G.randomChoice(V.BILLBOARDS),-t)}function U(){cars=[];for(var e,t,n,a,s,i,o,e=0;e<totalCars;e++)a=Math.random()*G.randomChoice([-.8,.8]),s=Math.floor(Math.random()*segments.length)*segmentLength,i=G.randomChoice(V.CARS),o=maxSpeed/4+Math.random()*maxSpeed/(i==V.SEMI?4:2),t={offset:a,z:s,sprite:i,speed:o},n=w(t.z),n.cars.push(t),cars.push(t)}function N(){X||(W.NewGame=!1,X=!0,P.run({canvas:canvas,render:x,update:g,stats:stats,step:step,images:["background1","sprites1"],keys:[{keys:[Y.LEFT,Y.A],mode:"down",action:function(){keyLeft=!0}},{keys:[Y.RIGHT,Y.D],mode:"down",action:function(){keyRight=!0}},{keys:[Y.UP,Y.W],mode:"down",action:function(){keyFaster=!0}},{keys:[Y.DOWN,Y.S],mode:"down",action:function(){keySlower=!0}},{keys:[Y.LEFT,Y.A],mode:"up",action:function(){keyLeft=!1}},{keys:[Y.RIGHT,Y.D],mode:"up",action:function(){keyRight=!1}}],ready:function(e){background=e[0],sprites=e[1],h(),m("開始"),W.stageList=G.shuffle(W.stageList),console.log(W.stageList),setTimeout(W.changeStage,1e3*maxTime)}}))}var B=function(){var e=Date.now(),t=e,n=0,a=1e3,s=0,i=0,o=1e3,r=0,l=0,c=0,d=document.createElement("div");d.id="stats",d.addEventListener("mousedown",function(e){e.preventDefault(),y(++c%2)},!1),d.style.cssText="width:80px;opacity:0.9;cursor:pointer";var h=document.createElement("div");h.id="fps",h.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#002",d.appendChild(h);var u=document.createElement("div");u.id="fpsText",u.style.cssText="color:#0ff;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px",u.innerHTML="FPS",h.appendChild(u);var m=document.createElement("div");for(m.id="fpsGraph",m.style.cssText="position:relative;width:74px;height:30px;background-color:#0ff",h.appendChild(m);m.children.length<74;){var p=document.createElement("span");p.style.cssText="width:1px;height:30px;float:left;background-color:#113",m.appendChild(p)}var g=document.createElement("div");g.id="ms",g.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#020;display:none",d.appendChild(g);var f=document.createElement("div");f.id="msText",f.style.cssText="color:#0f0;font-family:Helvetica,Arial,sans-serif;font-size:9px;font-weight:bold;line-height:15px",f.innerHTML="MS",g.appendChild(f);var L=document.createElement("div");for(L.id="msGraph",L.style.cssText="position:relative;width:74px;height:30px;background-color:#0f0",g.appendChild(L);L.children.length<74;){var p=document.createElement("span");p.style.cssText="width:1px;height:30px;float:left;background-color:#131",L.appendChild(p)}var y=function(e){switch(c=e){case 0:h.style.display="block",g.style.display="none";break;case 1:h.style.display="none",g.style.display="block"}},E=function(e,t){e.appendChild(e.firstChild).style.height=t+"px"};return{domElement:d,setMode:y,current:function(){return i},begin:function(){e=Date.now()},end:function(){var c=Date.now();return n=c-e,a=Math.min(a,n),s=Math.max(s,n),f.textContent=n+" MS ("+a+"-"+s+")",E(L,Math.min(30,30-n/200*30)),l++,c>t+1e3&&(i=Math.round(1e3*l/(c-t)),o=Math.min(o,i),r=Math.max(r,i),u.textContent=i+" FPS ("+o+"-"+r+")",E(m,Math.min(30,30-i/100*30)),t=c,l=0),c},update:function(){e=this.end()}}},_={get:function(e){return e instanceof HTMLElement||e===document?e:document.getElementById(e)},set:function(e,t){_.get(e).innerHTML=t},on:function(e,t,n,a){_.get(e).addEventListener(t,n,a)},un:function(e,t,n,a){_.get(e).removeEventListener(t,n,a)},show:function(e,t){_.get(e).style.display=t||"block"},blur:function(e){e.target.blur()},addClassName:function(e,t){_.toggleClassName(e,t,!0)},removeClassName:function(e,t){_.toggleClassName(e,t,!1)},toggleClassName:function(e,t,n){e=_.get(e);var a=e.className.split(" "),s=a.indexOf(t);n=void 0===n?s<0:n,n&&s<0?a.push(t):!n&&s>=0&&a.splice(s,1),e.className=a.join(" ")},storage:window.localStorage||{}},G={shuffle:function(e){var t,n,a;for(a=e.length;a;a--)t=Math.floor(Math.random()*a),n=e[a-1],e[a-1]=e[t],e[t]=n;return e},timestamp:function(){return(new Date).getTime()},toInt:function(e,t){if(null!==e){var n=parseInt(e,10);if(!isNaN(n))return n}return G.toInt(t,0)},toFloat:function(e,t){if(null!==e){var n=parseFloat(e);if(!isNaN(n))return n}return G.toFloat(t,0)},limit:function(e,t,n){return Math.max(t,Math.min(e,n))},randomInt:function(e,t){return Math.round(G.interpolate(e,t,Math.random()))},randomChoice:function(e){return e[G.randomInt(0,e.length-1)]},percentRemaining:function(e,t){return e%t/t},accelerate:function(e,t,n){return e+t*n},interpolate:function(e,t,n){return e+(t-e)*n},easeIn:function(e,t,n){return e+(t-e)*Math.pow(n,2)},easeOut:function(e,t,n){return e+(t-e)*(1-Math.pow(1-n,2))},easeInOut:function(e,t,n){return e+(t-e)*(-Math.cos(n*Math.PI)/2+.5)},exponentialFog:function(e,t){return 1/Math.pow(Math.E,e*e*t)},increase:function(e,t,n){for(var a=e+t;a>=n;)a-=n;for(;a<0;)a+=n;return a},project:function(e,t,n,a,s,i,o,r){e.camera.x=(e.world.x||0)-t,e.camera.y=(e.world.y||0)-n,e.camera.z=(e.world.z||0)-a,e.screen.scale=s/e.camera.z,e.screen.x=Math.round(i/2+e.screen.scale*e.camera.x*i/2),e.screen.y=Math.round(o/2-e.screen.scale*e.camera.y*o/2),e.screen.w=Math.round(e.screen.scale*r*i/2)},overlap:function(e,t,n,a,s){var i=(s||1)/2,o=e-t*i,r=e+t*i,l=n-a*i,c=n+a*i;return!(r<l||o>c)}};window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e,t){window.setTimeout(e,1e3/60)});var P={stagelist:[1,2,3,4,5,6,7,8,9],init:function(){G.shuffle(stagelist)},run:function(e){P.loadImages(e.images,function(t){function n(){for(l=G.timestamp(),d=Math.min(1,(l-c)/1e3),h+=d;h>o;)h-=o,s(o);i(),r.update(),c=l,requestAnimationFrame(n,a)}e.ready(t),P.setKeyListener(e.keys);var a=e.canvas,s=e.update,i=e.render,o=e.step,r=e.stats,l=null,c=G.timestamp(),d=0,h=0;n(),P.playMusic()})},loadImages:function(e,t){for(var n=[],a=e.length,s=function(){0==--a&&t(n)},i=0;i<e.length;i++){var o=e[i];n[i]=document.createElement("img"),_.on(n[i],"load",s),n[i].src="images/"+o+".png"}},setKeyListener:function(e){var t=function(t,n){var a,s;for(a=0;a<e.length;a++)s=e[a],s.mode=s.mode||"up",(s.key==t||s.keys&&s.keys.indexOf(t)>=0)&&s.mode==n&&s.action.call()},n=function(e){t(e.keyCode,"down")},a=function(e){t(e.keyCode,"up")};_.on(document,"keydown",n),_.on(document,"keyup",a),_.on(document,"finished",function(e){document.removeEventListener("keydown",n),document.removeEventListener("keyup",a)})},stats:function(e,t){var n=new B;n.domElement.id=t||"stats",_.get(e).appendChild(n.domElement);var a=document.createElement("div");a.style.cssText="border: 2px solid gray; padding: 5px; margin-top: 5px; text-align: left; font-size: 1.15em; text-align: right;",a.innerHTML="Your canvas performance is ",_.get(e).appendChild(a);var s=document.createElement("span");return s.innerHTML="...",a.appendChild(s),setInterval(function(){var e=n.current(),t=e>50?"good":e<30?"bad":"ok",i=e>50?"green":e<30?"red":"gray";s.innerHTML=t,s.style.color=i,a.style.borderColor=i},5e3),n},playMusic:function(){var e=_.get("music");e.loop=!0,e.volume=.05,e.muted="true"===_.storage.muted,e.play(),_.toggleClassName("mute","on",e.muted),_.on("mute","click",function(){_.storage.muted=e.muted=!e.muted,_.toggleClassName("mute","on",e.muted)})}},F={polygon:function(e,t,n,a,s,i,o,r,l,c){e.fillStyle=c,e.beginPath(),e.moveTo(t,n),e.lineTo(a,s),e.lineTo(i,o),e.lineTo(r,l),e.closePath(),e.fill()},segment:function(e,t,n,a,s,i,o,r,l,c,d){var h,u,m,p,g,f=F.rumbleWidth(i,n),L=F.rumbleWidth(l,n),y=F.laneMarkerWidth(i,n),E=F.laneMarkerWidth(l,n);if(e.fillStyle=d.grass,e.fillRect(0,r,t,s-r),F.polygon(e,a-i-f,s,a-i,s,o-l,r,o-l-L,r,d.rumble),F.polygon(e,a+i+f,s,a+i,s,o+l,r,o+l+L,r,d.rumble),F.polygon(e,a-i,s,a+i,s,o+l,r,o-l,r,d.road),d.lane)for(h=2*i/n,u=2*l/n,m=a-i+h,p=o-l+u,g=1;g<n;m+=h,p+=u,g++)F.polygon(e,m-y/2,s,m+y/2,s,p+E/2,r,p-E/2,r,d.lane);F.fog(e,0,s,t,r-s,c)},background:function(e,t,n,a,s,i,o){i=i||0,o=o||0;var r=s.w/2,l=s.h,c=s.x+Math.floor(s.w*i),d=s.y,h=Math.min(r,s.x+s.w-c),u=l,m=o,p=Math.floor(n*(h/r)),g=a;e.drawImage(t,c,d,h,u,0,m,p,g),h<r&&e.drawImage(t,s.x,d,r-h,u,p-1,m,n-p,g)},sprite:function(e,t,n,a,s,i,o,r,l,c,d,h,u){var m=o.w*r*t/2*(V.SCALE*s),p=o.h*r*t/2*(V.SCALE*s);l+=m*(d||0),c+=p*(h||0);var g=u?Math.max(0,c+p-u):0;g<p&&e.drawImage(i,o.x,o.y,o.w,o.h-o.h*g/p,l,c,m,p-g)},player:function(e,t,n,a,s,i,o,r,l,c,d,h){var u,m=1.5*Math.random()*o*a*G.randomChoice([-1,1]);u=d<0?h>0?V.PLAYER_UPHILL_LEFT:V.PLAYER_LEFT:d>0?h>0?V.PLAYER_UPHILL_RIGHT:V.PLAYER_RIGHT:h>0?V.PLAYER_UPHILL_STRAIGHT:V.PLAYER_STRAIGHT,F.sprite(e,t,n,a,s,i,u,r,l,c+m,-.5,-1)},fog:function(e,t,n,a,s,i){i<1&&(e.globalAlpha=1-i,e.fillStyle=z.FOG,e.fillRect(t,n,a,s),e.globalAlpha=1)},rumbleWidth:function(e,t){return e/Math.max(6,2*t)},laneMarkerWidth:function(e,t){return e/Math.max(32,8*t)}},W={stageList:[1,2,3,4,5,6,7,8],NewGame:!0,stagePtr:0,nextLevel:function(){return console.log("called nextLevel"),document.getElementById("totalCars").value*=1.1,document.getElementById("maxSpeed").value*=1.1,document.getElementById("submit").click(),!1},previousLevel:function(){return console.log("called previousLevel"),document.getElementById("totalCars").value/=1.1,document.getElementById("maxSpeed").value/=1.1,document.getElementById("submit").click(),!1},changeStage:function(){if(W.stagePtr=(W.stagePtr+1)%W.stageList.length,W.stagePtr>0&&W.stagePtr<W.stageList.length){P.loadImages(["background"+W.stageList[W.stagePtr],"sprites"+W.stageList[W.stagePtr]],function(e){background=e[0],sprites=e[1],h()});var e=document.getElementById("music"),t=document.getElementById("audioSource");e.load(),t.src="music/music"+W.stageList[W.stagePtr]+".mp3",P.playMusic(),m("下一關"),W.stagePtr<W.stageList.length-1?setTimeout(W.changeStage,1e3*maxTime):setTimeout(u,1e3*maxTime)}}},Y={LEFT:37,UP:38,RIGHT:39,DOWN:40,A:65,D:68,S:83,W:87},z={SKY:"#72D7EE",TREE:"#005108",FOG:"#005108",LIGHT:{road:"#6B6B6B",grass:"#10AA10",rumble:"#555555",lane:"#CCCCCC"},DARK:{road:"#696969",grass:"#009A00",rumble:"#BBBBBB"},START:{road:"white",grass:"white",rumble:"white"},FINISH:{road:"black",grass:"black",rumble:"black"}},q={HILLS:{x:5,y:5,w:1280,h:480},SKY:{x:5,y:495,w:1280,h:480},TREES:{x:5,y:985,w:1280,h:480}},V={PALM_TREE:{x:5,y:5,w:215,h:540},BILLBOARD08:{x:230,y:5,w:385,h:265},TREE1:{x:625,y:5,w:360,h:360},DEAD_TREE1:{x:5,y:555,w:135,h:332},BILLBOARD09:{x:150,y:555,w:328,h:282},BOULDER3:{x:230,y:280,w:320,h:220},COLUMN:{x:995,y:5,w:200,h:315},BILLBOARD01:{x:625,y:375,w:300,h:170},BILLBOARD06:{x:488,y:555,w:298,h:190},BILLBOARD05:{x:5,y:897,w:298,h:190},BILLBOARD07:{x:313,y:897,w:298,h:190},BOULDER2:{x:621,y:897,w:298,h:140},TREE2:{x:1205,y:5,w:282,h:295},BILLBOARD04:{x:1205,y:310,w:268,h:170},DEAD_TREE2:{x:1205,y:490,w:150,h:260},BOULDER1:{x:1205,y:760,w:168,h:248},BUSH1:{x:5,y:1097,w:240,h:155},CACTUS:{x:929,y:897,w:235,h:118},BUSH2:{x:255,y:1097,w:232,h:152},BILLBOARD03:{x:5,y:1262,w:230,h:220},BILLBOARD02:{x:245,y:1262,w:215,h:220},STUMP:{x:995,y:330,w:195,h:140},SEMI:{x:1365,y:490,w:122,h:144},TRUCK:{x:1365,y:644,w:100,h:78},CAR03:{x:1383,y:760,w:88,h:55},CAR02:{x:1383,y:825,w:80,h:59},CAR04:{x:1383,y:894,w:80,h:57},CAR01:{x:1205,y:1018,w:80,h:56},PLAYER_UPHILL_LEFT:{x:1383,y:961,w:80,h:45},PLAYER_UPHILL_STRAIGHT:{x:1295,y:1018,w:80,h:45},PLAYER_UPHILL_RIGHT:{x:1385,y:1018,w:80,h:45},PLAYER_LEFT:{x:995,y:480,w:80,h:41},PLAYER_STRAIGHT:{x:1085,y:480,w:80,h:41},PLAYER_RIGHT:{x:995,y:531,w:80,h:41}};V.SCALE=1/V.PLAYER_STRAIGHT.w*.3,V.BILLBOARDS=[V.BILLBOARD01,V.BILLBOARD02,V.BILLBOARD03,V.BILLBOARD04,V.BILLBOARD05,V.BILLBOARD06,V.BILLBOARD07,V.BILLBOARD08,V.BILLBOARD09],V.PLANTS=[V.TREE1,V.TREE2,V.DEAD_TREE1,V.DEAD_TREE2,V.PALM_TREE,V.BUSH1,V.BUSH2,V.CACTUS,V.STUMP,V.BOULDER1,V.BOULDER2,V.BOULDER3],V.CARS=[V.CAR01,V.CAR02,V.CAR03,V.CAR04,V.SEMI,V.TRUCK];var X=!1;window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}();var Z,K,j=document.getElementById("firework"),J=j.getContext("2d"),Q=canvas.height,ee=canvas.width,te=[],ne=[],ae=120,se=5,ie=0,oe=20,re=0,le=!1;s.prototype.update=function(e){this.coordinates.pop(),this.coordinates.unshift([this.x,this.y]),this.targetRadius<8?this.targetRadius+=.3:this.targetRadius=1,this.speed*=this.acceleration;var t=Math.cos(this.angle)*this.speed,n=Math.sin(this.angle)*this.speed;this.distanceTraveled=a(this.sx,this.sy,this.x+t,this.y+n),this.distanceTraveled>=this.distanceToTarget?(o(this.tx,this.ty),te.splice(e,1)):(this.x+=t,this.y+=n)},s.prototype.draw=function(){J.beginPath(),J.moveTo(this.coordinates[this.coordinates.length-1][0],this.coordinates[this.coordinates.length-1][1]),J.lineTo(this.x,this.y),J.strokeStyle="hsl("+ae+", 100%, "+this.brightness+"%)",J.stroke(),J.beginPath(),J.arc(this.tx,this.ty,this.targetRadius,0,2*Math.PI),J.stroke()},i.prototype.update=function(e){this.coordinates.pop(),this.coordinates.unshift([this.x,this.y]),this.speed*=this.friction,this.x+=Math.cos(this.angle)*this.speed,this.y+=Math.sin(this.angle)*this.speed+this.gravity,this.alpha-=this.decay,this.alpha<=this.decay&&ne.splice(e,1)},i.prototype.draw=function(){J.beginPath(),J.moveTo(this.coordinates[this.coordinates.length-1][0],this.coordinates[this.coordinates.length-1][1]),J.lineTo(this.x,this.y),J.strokeStyle="hsla("+this.hue+", 100%, "+this.brightness+"%, "+this.alpha+")",J.stroke()},$(document).ready(function(){function e(){var e=$("#canvas"),t=$(window);if(document.webkitIsFullScreen||document.mozFullScreen||null!==document.msFullscreenElement){var n=t.width(),a=t.height(),s=n/a,i=e.width()/e.height(),o=i<s;console.log(o),o?(e.css("height",a+"px"),e.css("width",a*i+"px"),e.css("left",-(e.width()-t.width())/2+"px")):(e.css("height",n/i+"px"),e.css("width",n+"px"),e.css("top",-(e.height()-t.height())/2+"px")),h(),N()}null==(document.webkitIsFullScreen||document.mozFullScreen||document.msFullscreenElement)&&(e.css("width","640px"),e.css("height","480px"),e.css("left"," 0px"),e.css("top","0px"),h())}$("#restartbutton").hide(),$("#startbutton").click(N),$("#fullscreen").click(c),$("#startbutton").click(function(){$("#restartbutton").show(),$("#startbutton").hide()}),p(),h(),document.addEventListener&&(document.addEventListener("webkitfullscreenchange",e,!1),document.addEventListener("mozfullscreenchange",e,!1),document.addEventListener("fullscreenchange",e,!1),document.addEventListener("MSFullscreenChange",e,!1))});var ce={LENGTH:{NONE:0,SHORT:25,MEDIUM:50,LONG:100},HILL:{NONE:0,LOW:20,MEDIUM:40,HIGH:60},CURVE:{NONE:0,EASY:2,MEDIUM:4,HARD:6}};_.on("roadWidth","change",function(e){_.blur(e),h({roadWidth:G.limit(G.toInt(e.target.value),G.toInt(e.target.getAttribute("min")),G.toInt(e.target.getAttribute("max")))})}),_.on("totalCars","change",function(e){_.blur(e),h({totalCars:G.limit(G.toInt(e.target.value),G.toInt(e.target.getAttribute("min")),G.toInt(e.target.getAttribute("max")))})}),_.on("maxSpeed","change",function(e){_.blur(e),h({maxSpeed:G.limit(G.toInt(e.target.value),G.toInt(e.target.getAttribute("min")),G.toInt(e.target.getAttribute("max")))})}),_.on("maxTime","change",function(e){_.blur(e),h({maxTime:G.limit(G.toInt(e.target.value),G.toInt(e.target.getAttribute("min")),G.toInt(e.target.getAttribute("max")))}),W.stagePtr<W.stageList.length-1?(clearTimeout(W.changeStage),setTimeout(W.changeStage,1e3*maxTime)):W.stagePtr==W.stageList.length-1&&(clearTimeout(u),setTimeout(u,1e3*maxTime))})}]);